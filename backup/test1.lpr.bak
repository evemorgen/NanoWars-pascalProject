program test1;

uses dos, crt, allegro, sysutils;




var configTAB                  : array of integer; //tablica dynamiczna zawierąca wszystkie dane z configu
var i,j                        : integer;
var rMouseBTAB                 : array of integer;
var buffer                     : al_BITMAPptr;
var wspolczynnikRozdzielczosci : integer;      //1 dla 4:3, 0 dla 16:9
var sprite                     : al_BITMAPptr;
var spriteBLUE                 : array[1..16] of al_BITMAPptr;
var spriteRED                  : array[1..16] of al_BITMAPptr;
var spriteWHITE                : array[1..16] of al_BITMAPptr;
var ilosc                      : integer;
var klik                       : integer;
var zlicz                      : integer;
var flaga                      : integer;
var zOnoFF                     : integer;

{$I NWsprites.pas}
{$I NWcells.pas}
{$I NWbubbleList.pas}
{$I NWatStart.pas}
{$I NWmenu.pas}
{$I NWgameEngine.pas}


procedure levelEditor();
var levelName : string;
    znak      : integer;
    bufforek  : al_BITMAPptr;
    level     : text;
    i,j       : integer;
    ilosc     : integer;
    zlicz     : integer;
    stala     : integer;
begin
  ilosc := 0;
  zlicz := 0;
  stala := 100;
  levelName := '';
  bufforek := al_create_bitmap(al_SCREEN_W,al_SCREEN_H);
  while al_key[al_KEY_ENTER] = 0 do
        begin
        al_clear_bitmap(bufforek);
        al_textout_centre_ex (bufforek, al_font,'wpisz nazwe swojego lvlu', al_SCREEN_W DIV 2, (al_SCREEN_H DIV 2), al_makecol (255, 255, 255), -1);
        al_textout_centre_ex (bufforek, al_font,'zatwierdz klawiszem ENTER', al_SCREEN_W DIV 2, (al_SCREEN_H DIV 2)+20, al_makecol (255, 255, 255), -1);
        al_textout_centre_ex (bufforek, al_font,levelName, al_SCREEN_W DIV 2, (al_SCREEN_H DIV 2)+40, al_makecol (255, 255, 255), -1);
        al_blit(bufforek,al_screen,0,0,0,0,al_SCREEN_W,al_SCREEN_H);
        znak := al_readkey();
        if znak = 16136 then levelName := copy(levelName,0,length(levelName)-1)
        else levelName := levelName + char(znak);
        end;
  levelName := 'lvl\' + copy(levelName,0,length(levelName)-1) + '.lvl';
  assign(level,levelName);
  rewrite(level);

  initCell(1,al_SCREEN_W-120,60+stala,10,1,0,random(16)+1);//ktoraKomorka, X,Y,points,size,id,spriteNr : integer
  initCell(2,al_SCREEN_W-120,120+stala,10,3,0,random(16)+1);
  initCell(3,al_SCREEN_W-120,210+stala,10,1,1,random(16)+1);
  initCell(4,al_SCREEN_W-120,270+stala,10,3,1,random(16)+1);
  initCell(5,al_SCREEN_W-120,360+stala,10,1,2,random(16)+1);
  initCell(6,al_SCREEN_W-120,420+stala,10,3,2,random(16)+1);
  al_rest(100);

  while (al_key[al_KEY_ENTER] = 0) do
        begin
        al_clear_bitmap(buffer);
        al_textout_centre_ex (buffer, al_font,'Nacisnij na komorke z prawej strony ekranu,', al_SCREEN_W DIV 2, 20, al_makecol (255, 255, 255), -1);
        al_textout_centre_ex (buffer, al_font,'nastepnie przeciagnij ja we wlasciwe miejsce', al_SCREEN_W DIV 2, 40, al_makecol (255, 255, 255), -1);
        al_textout_centre_ex (buffer, al_font,'aby zatwierdzic pozycje nacisnij spacje.', al_SCREEN_W DIV 2, 60, al_makecol (255, 255, 255), -1);
        al_textout_centre_ex (buffer, al_font,'ABY ZAKOŃCZYĆ PRACĘ Z EDYTOREM NACIŚNIJ ENTER', al_SCREEN_W DIV 2, 80, al_makecol (255, 255, 255), -1);


        for i := 1 to ilosc + 6 do
            drawCell(i,zlicz);
        for i := 1 to ilosc+6 do
               begin
               if ((al_mouse_b AND 1) <> 0) and (al_mouse_x >= komorkiNaPlanszy[i].posX) and (al_mouse_x <= komorkiNaPlanszy[i].posX + 60) and (al_mouse_y >= komorkiNaPlanszy[i].posY) and (al_mouse_y <= komorkiNaPlanszy[i].posY + 60) then
                  begin
                  ilosc := ilosc + 1;
                  initCell(ilosc+6,al_mouse_x,al_mouse_y,10,komorkiNaPlanszy[i].rozmiar,komorkiNaPlanszy[i].ID,random(16)+1);
                  al_rest(100);
                  while (al_key[al_KEY_SPACE] = 0) do
                        begin
                        al_clear_bitmap(buffer);
                        for j := 1 to ilosc + 6 do
                            begin drawCell(j,zlicz); end;
                        komorkiNaPlanszy[ilosc+6].posX := al_mouse_x;
                        komorkiNaPlanszy[ilosc+6].posY := al_mouse_y;
                        zlicz := (zlicz + 1) mod 10000;
                        al_show_mouse(buffer);
                        al_blit(buffer,al_screen,0,0,0,0,al_SCREEN_W,al_SCREEN_H);
                        al_rest(1);
                        end;
                  end;
               end;
        zlicz := (zlicz + 1) mod 10000;
        al_show_mouse(buffer);
        al_blit(buffer,al_screen,0,0,0,0,al_SCREEN_W,al_SCREEN_H);
        al_rest(1);
        end;
  for i:= 7 to ilosc+6 do
      begin
      write(level,komorkiNaPlanszy[i].posX,' ',komorkiNaPlanszy[i].posY,' ',komorkiNaPlanszy[i].punkty,' ',komorkiNaPlanszy[i].rozmiar,' ',komorkiNaPlanszy[i].ID);
      if i <> ilosc+6 then writeln(level);
      end;
  close(level);
end;




var cos : string;

begin
  initAll();

  Setlength(komorkiNaPlanszy,256);                    //brzydkie rozwiązanie ale dziala :D

  pickRes();
  //menu();
  ilosc := 10;
  klik := 0;
  zlicz := 0;
  bubbleCount := 0;
  zOnOFF := 0;
  loadSprites;

  buffer := al_create_bitmap(al_SCREEN_W,al_SCREEN_H);
  al_clear_bitmap(buffer);

  //levelEditor();

  //for i:= 1 to 7 do initCell(i,random(al_SCREEN_W-110)+55,random(al_SCREEN_H-110)+55,random(20)+10,1,random(3),random(16)+1); //ktoraKomorka, X,Y,points,size,id,promien
  //for i:= 8 to 10 do initCell(i,random(al_SCREEN_W-110)+55,random(al_SCREEN_H-110)+55,random(20)+10,3,random(3),random(16)+1); //ktoraKomorka, X,Y,points,size,id,promien
  loadLevel('test2.lvl');
  playLevel();

  loadLevel('2.lvl');
  playLevel();

  al_destroy_bitmap(buffer);
  destroySprites;
  al_exit;
end.
